<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#1e293b">
<title>Star Hexes</title>

<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
  margin: 0;
  overflow: hidden;
  touch-action: none;
}
#root {
  width: 100vw;
  height: 100vh;
}
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

/* =======================
   CONFIGURAZIONE GENERALE
   ======================= */
const CONFIG = {
  mapWidth: 9,
  mapHeight: 7,
  capitalZones: {
    player1: [0, 1, 2],
    player2: [6, 7, 8]
  },
  unitHealth: 100,
  baseDamage: 30,
  capitalDamage: 20
};

/* =======================
   UTILS HEX GRID
   ======================= */
const hexUtils = {
  getNeighbors: (q, r) => {
    const even = r % 2 === 0;
    return even
      ? [[q+1,r],[q-1,r],[q,r-1],[q-1,r-1],[q,r+1],[q-1,r+1]]
      : [[q+1,r],[q-1,r],[q+1,r-1],[q,r-1],[q+1,r+1],[q,r+1]];
  }
};

/* =======================
   ICONA UNITA'
   ======================= */
const PlaneIcon = ({ x, y, size, color }) => (
  <path
    d={`M ${x} ${y-size/2} L ${x+size/3} ${y+size/2} L ${x} ${y+size/3} L ${x-size/3} ${y+size/2} Z`}
    fill={color}
    pointerEvents="none"
  />
);

/* =======================
   COMPONENTE PRINCIPALE
   ======================= */
function StarHexesGame() {

  const [units, setUnits] = useState([]);
  const [currentPlayer, setCurrentPlayer] = useState(1);
  const [selectedUnit, setSelectedUnit] = useState(null);
  const [activatedUnits, setActivatedUnits] = useState(new Set());
  const [gamePhase, setGamePhase] = useState("action");

  /* =======================
     INIZIALIZZAZIONE UNITA'
     ======================= */
  useEffect(() => {
    setUnits([
      { id:"p1_1", player:1, q:1, r:2, health:100 },
      { id:"p1_2", player:1, q:1, r:3, health:100 },
      { id:"p1_3", player:1, q:1, r:4, health:100 },
      { id:"p2_1", player:2, q:7, r:2, health:100 },
      { id:"p2_2", player:2, q:7, r:3, health:100 },
      { id:"p2_3", player:2, q:7, r:4, health:100 }
    ]);
  }, []);

  /* =======================
     HELPER UNITA'
     ======================= */
  const getUnitAt = (q,r) =>
    units.find(u => u.q===q && u.r===r && u.health>0);

  const isOccupied = (q,r,id=null) =>
    units.some(u => u.q===q && u.r===r && u.id!==id && u.health>0);

  /* =======================
     MOVIMENTO
     ======================= */
  const getValidMoves = (unit) => {
    return hexUtils.getNeighbors(unit.q, unit.r)
      .filter(([q,r]) =>
        q>=0 && q<CONFIG.mapWidth &&
        r>=0 && r<CONFIG.mapHeight &&
        !isOccupied(q,r,unit.id)
      );
  };

  /* =======================
     CLICK SU UNITA'
     ======================= */
  const handleUnitClick = (unit) => {
    if (gamePhase !== "action") return;
    if (unit.player !== 1) return;
    if (activatedUnits.has(unit.id)) return;
    setSelectedUnit(unit);
  };

  /* =======================
     CLICK SU ESAGONO
     ======================= */
  const handleHexClick = (q,r) => {
    if (!selectedUnit) return;

    const valid = getValidMoves(selectedUnit)
      .some(([mq,mr]) => mq===q && mr===r);

    if (!valid) return;

    setUnits(units.map(u =>
      u.id===selectedUnit.id ? { ...u, q, r } : u
    ));

    setActivatedUnits(prev => new Set(prev).add(selectedUnit.id));
    setSelectedUnit(null);

    setCurrentPlayer(2);
    setTimeout(makeAIMove, 600);
  };

  /* =======================
     IA
     ======================= */
  const makeAIMove = () => {
    const ai = units.find(u =>
      u.player===2 && u.health>0 && !activatedUnits.has(u.id)
    );

    if (!ai) {
      setCurrentPlayer(1);
      return;
    }

    const moves = getValidMoves(ai);
    if (moves.length) {
      const [q,r] = moves[0];
      setUnits(prev => prev.map(u =>
        u.id===ai.id ? { ...u, q, r } : u
      ));
    }

    setActivatedUnits(prev => new Set(prev).add(ai.id));
    setCurrentPlayer(1);
  };

  /* =====================================================
     ðŸ”´ FIX PRINCIPALE
     Controlla AUTOMATICAMENTE fine round
     ===================================================== */
  useEffect(() => {
    if (gamePhase !== "action") return;

    const alive = units.filter(u => u.health > 0);
    if (!alive.length) return;

    const allActivated = alive.every(u => activatedUnits.has(u.id));

    if (allActivated) {
      resolveCombat();
    }
  }, [activatedUnits, units, gamePhase]);

  /* =======================
     COMBATTIMENTO
     ======================= */
  const resolveCombat = () => {
    setGamePhase("combat");

    let newUnits = [...units];

    newUnits.forEach(u => {
      const enemies = hexUtils.getNeighbors(u.q,u.r)
        .map(([q,r]) => getUnitAt(q,r))
        .filter(n => n && n.player!==u.player);

      if (enemies.length) {
        const dmg = CONFIG.baseDamage / enemies.length;
        enemies.forEach(e => {
          newUnits = newUnits.map(x =>
            x.id===e.id ? { ...x, health: Math.max(0,x.health-dmg) } : x
          );
        });
      }
    });

    setUnits(newUnits);

    setTimeout(() => {
      setActivatedUnits(new Set());
      setGamePhase("action");
      setCurrentPlayer(1);
    }, 2000);
  };

  /* =======================
     RENDER
     ======================= */
  return (
    <div className="w-full h-full bg-gray-900 text-white">
      <div className="text-center p-2">
        {gamePhase==="action" ? `Turno P${currentPlayer}` : "COMBATTIMENTO"}
      </div>

      <svg viewBox="0 0 550 350" className="w-full h-full">
        {Array.from({length:CONFIG.mapHeight},(_,r)=>
          Array.from({length:CONFIG.mapWidth},(_,q)=>{
            const x = q*50 + (r%2)*25 + 40;
            const y = r*43 + 40;
            const u = getUnitAt(q,r);

            return (
              <g key={`${q}-${r}`}>
                <polygon
                  points={`${x},${y-25} ${x+22},${y-12} ${x+22},${y+12} ${x},${y+25} ${x-22},${y+12} ${x-22},${y-12}`}
                  fill="#1e293b"
                  stroke="#475569"
                  onClick={() => u ? handleUnitClick(u) : handleHexClick(q,r)}
                />
                {u && (
                  <>
                    <circle cx={x} cy={y} r="15" fill={u.player===1?"#3b82f6":"#ef4444"} />
                    <PlaneIcon x={x} y={y} size={14} color="white" />
                  </>
                )}
              </g>
            );
          })
        )}
      </svg>
    </div>
  );
}

ReactDOM.render(<StarHexesGame />, document.getElementById("root"));
</script>
</body>
</html>
